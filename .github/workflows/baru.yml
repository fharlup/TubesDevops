name: Laravel CI & SonarCloud Analysis

on:
push:
branches: [ "main" ]
pull_request:
branches: [ "main" ]

jobs:
test-and-analyze:
runs-on: ubuntu-latest

steps:
  # 1. Checkout repo (PENTING: butuh fetch-depth: 0 untuk Sonar)
  - name: Checkout code
    uses: actions/checkout@v4
    with:
      fetch-depth: 0 # Diperlukan untuk SonarCloud analysis

  # 2. Setup PHP (dengan Xdebug untuk coverage)
  - name: Setup PHP
    uses: shivammathur/setup-php@bf6b4fbd49ca58e4608c9c89fba0b8d90bd2a39f
    with:
      php-version: '8.2'
      extensions: mbstring, bcmath, sqlite, intl, xdebug, dom, curl, gd, xml, pdo, pdo_mysql
      coverage: xdebug # Mengaktifkan Xdebug

  # 3. Install composer dependencies
  - name: Install composer dependencies
    run: composer install --no-progress --prefer-dist --optimize-autoloader

  # 4. Setup .env dengan SQLite
  - name: Setup .env
    run: |
      cp .env.example .env || echo "" > .env
      echo "APP_NAME=Laravel" > .env
      echo "APP_ENV=testing" >> .env
      echo "APP_KEY=" >> .env
      echo "APP_DEBUG=true" >> .env
      echo "APP_URL=http://localhost" >> .env
      echo "DB_CONNECTION=sqlite" >> .env
      echo "DB_DATABASE=$(pwd)/database/database.sqlite" >> .env

  # 5. Buat file SQLite
  - name: Create SQLite database
    run: mkdir -p database && touch database/database.sqlite

  # 6. Setup Node.js
  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20'

  # 7. Install frontend dependencies
  - name: Install frontend dependencies
    run: npm install

  # 8. Build frontend assets
  - name: Build frontend assets
    run: npm run build

  # 9. Generate APP_KEY
  - name: Generate application key
    run: php artisan key:generate

  # 10. Jalankan migrasi
  - name: Run migrations
    run: php artisan migrate --force

  # 11. Buat folder untuk laporan
  - name: Create logs directory
    run: mkdir -p build/logs

  # 12. Jalankan test DAN BUAT LAPORAN COVERAGE
  - name: Run tests with coverage
    run: php artisan test --coverage --coverage-clover=build/logs/clover.xml

  # 13. JALANKAN SONARCLOUD SCAN
  # (Gunakan action untuk SonarCloud, bukan SonarQube)
  - name: SonarCloud Scan
    uses: SonarSource/sonarcloud-scan-action@v2
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      # Anda HARUS menambahkan 2 baris ini di 'secrets' GitHub Anda
      # Ambil valuenya dari dashboard SonarCloud proyek Anda
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
    with:
      # Ini akan memberitahu SonarCloud untuk mencari laporan
      # di file sonar-project.properties Anda
      # Pastikan file sonar-project.properties Anda berisi baris:
      # sonar.php.coverage.reportPaths=build/logs/clover.xml
      args: >
        -Dsonar.php.coverage.reportPaths=build/logs/clover.xml
