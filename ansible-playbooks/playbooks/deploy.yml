---
# deploy.yml - Complete deployment playbook
- name: Deploy Healthcare Application
  hosts: webservers
  become: yes
  vars_files:
    - ../vars/main.yml
    - ../vars/vault.yml

  tasks:
    - name: "=== PHASE 1: Preparation ==="
      debug:
        msg: "Starting deployment preparation..."

    - name: Create application directory
      file:
        path: "{{ app_root }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Clone/Update application repository
      git:
        repo: "{{ git_repo }}"
        dest: "{{ app_root }}"
        version: "{{ git_branch }}"
        force: yes
      become_user: "{{ ansible_user }}"
      tags: ['git']

    - name: "=== PHASE 2: Docker Image Building==="
      debug:
        msg: "Building Docker images..."

    - name: Check if Dockerfile exists
      stat:
        path: "{{ app_root }}/Dockerfile"
      register: dockerfile_stat

    - name: Fail if Dockerfile missing
      fail:
        msg: "Dockerfile not found! Please ensure Dockerfile is in the repository."
      when: not dockerfile_stat.stat.exists

    - name: Build Laravel Docker image
      command: docker build -t {{ app_name }}:{{ git_branch }} .
      args:
        chdir: "{{ app_root }}"
      become_user: "{{ ansible_user }}"
      register: docker_build
      tags: ['docker-build', 'fajar']

    - name: Display build output
      debug:
        var: docker_build.stdout_lines
      when: docker_build is defined

    - name: Tag image with latest
      command: docker tag {{ app_name }}:{{ git_branch }} {{ app_name }}:latest
      become_user: "{{ ansible_user }}"
      tags: ['docker-build', 'fajar']

    - name: "=== PHASE 3: Configuration Setup ==="
      debug:
        msg: "Configuring application environment..."

    - name: Copy environment file
      template:
        src: ../roles/application/templates/env.j2
        dest: "{{ app_root }}/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
      tags: ['config']

    - name: Copy docker-compose file
      template:
        src: ../roles/application/templates/docker-compose.yml.j2
        dest: "{{ app_root }}/docker-compose.yml"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
      tags: ['config']

    - name: "=== PHASE 4: Docker Compose Deployment ==="
      debug:
        msg: "Deploying containers with Docker Compose..."

    - name: Stop existing containers
      command: docker-compose down
      args:
        chdir: "{{ app_root }}"
      ignore_errors: yes
      become_user: "{{ ansible_user }}"
      tags: ['docker-compose']

    - name: Pull required base images
      command: docker-compose pull
      args:
        chdir: "{{ app_root }}"
      become_user: "{{ ansible_user }}"
      ignore_errors: yes
      tags: ['docker-compose']

    - name: Start all containers with docker-compose
      command: docker-compose up -d --build
      args:
        chdir: "{{ app_root }}"
      become_user: "{{ ansible_user }}"
      register: compose_up
      tags: ['docker-compose']

    - name: Display docker-compose status
      command: docker-compose ps
      args:
        chdir: "{{ app_root }}"
      become_user: "{{ ansible_user }}"
      register: compose_status
      tags: ['docker-compose']

    - name: Show running containers
      debug:
        var: compose_status.stdout_lines

    - name: "=== PHASE 5: Application Initialization ==="
      debug:
        msg: "Initializing Laravel application..."

    - name: Wait for MySQL to be ready
      wait_for:
        host: localhost
        port: 3306
        delay: 10
        timeout: 120
      tags: ['init']

    - name: Wait for application container to be ready
      wait_for:
        port: "{{ app_port }}"
        delay: 10
        timeout: 120
      tags: ['init']

    - name: Install Composer dependencies
      command: docker-compose exec -T laravel composer install --no-interaction --optimize-autoloader
      args:
        chdir: "{{ app_root }}"
      become_user: "{{ ansible_user }}"
      when: run_composer | default(true)
      tags: ['init']

    - name: Generate application key
      command: docker-compose exec -T laravel php artisan key:generate --force
      args:
        chdir: "{{ app_root }}"
      become_user: "{{ ansible_user }}"
      when: generate_key | default(true)
      tags: ['init']

    - name: Run database migrations
      command: docker-compose exec -T laravel php artisan migrate --force
      args:
        chdir: "{{ app_root }}"
      become_user: "{{ ansible_user }}"
      when: run_migrations | default(true)
      tags: ['init', 'database']

    - name: Seed database
      command: docker-compose exec -T laravel php artisan db:seed --force
      args:
        chdir: "{{ app_root }}"
      become_user: "{{ ansible_user }}"
      when: run_seeders | default(false)
      tags: ['init', 'database']

    - name: Clear and cache configurations
      command: "{{ item }}"
      args:
        chdir: "{{ app_root }}"
      loop:
        - docker-compose exec -T laravel php artisan config:cache
        - docker-compose exec -T laravel php artisan route:cache
        - docker-compose exec -T laravel php artisan view:cache
      become_user: "{{ ansible_user }}"
      ignore_errors: yes
      tags: ['init', 'cache']

    - name: "=== PHASE 6: Verification ==="
      debug:
        msg: "Verifying deployment..."

    - name: Check application health
      uri:
        url: "http://{{ ansible_host }}:{{ app_port }}"
        status_code: 200
        timeout: 30
      register: app_health
      retries: 5
      delay: 10
      until: app_health.status == 200
      tags: ['verify']

    - name: Check phpMyAdmin
      uri:
        url: "http://{{ ansible_host }}:8081"
        status_code: 200
        timeout: 30
      register: phpmyadmin_health
      ignore_errors: yes
      tags: ['verify']

    - name: "=== DEPLOYMENT SUMMARY ==="
      debug:
        msg: |
          ========================================
          Deployment Successful!
          ========================================
          Application: http://{{ ansible_host }}:{{ app_port }}
          phpMyAdmin: http://{{ ansible_host }}:8081
          Database: localhost:3306
          
          Containers Status:
          {{ compose_status.stdout }}
          
          Completed Tasks:
          ✓ Docker Image Built
          ✓ Docker Compose Deployed
          ✓ Database Migrated
          ✓ Application Initialized
          ========================================