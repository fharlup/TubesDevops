---
# roles/common/tasks/main.yml - buatan arga
- name: "=== COMMON SETUP (Arga's Control Server) ==="
  debug:
    msg: "Setting up base system requirements..."

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Install common packages
  apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - net-tools
      - software-properties-common
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - python3
      - python3-pip
      - build-essential
    state: present
  when: ansible_os_family == "Debian"

- name: Install Python Docker SDK
  apt:
    name:
      - python3-docker
      - python3-requests
    state: present
  become: yes

- name: Create application user
  user:
    name: "{{ ansible_user }}"
    shell: /bin/bash
    createhome: yes
    groups: sudo
    append: yes

- name: Create application root directory
  file:
    path: "{{ app_root }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Set up firewall rules
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "22"      # SSH
    - "80"      # HTTP
    - "443"     # HTTPS
    - "{{ app_port }}"  # Application
    - "3306"    # MySQL
    - "{{ prometheus_port }}"  # Prometheus
    - "{{ grafana_port }}"     # Grafana
  when: configure_firewall | default(true)

- name: Enable UFW
  ufw:
    state: enabled
  when: configure_firewall | default(true)

- name: Configure system limits
  pam_limits:
    domain: '*'
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
  loop:
    - { type: 'soft', item: 'nofile', value: '65536' }
    - { type: 'hard', item: 'nofile', value: '65536' }
    - { type: 'soft', item: 'nproc', value: '32768' }
    - { type: 'hard', item: 'nproc', value: '32768' }

- name: Configure sysctl
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: 'vm.max_map_count', value: '262144' }
    - { name: 'fs.file-max', value: '65536' }
    - { name: 'net.ipv4.ip_forward', value: '1' }

- name: Check system resources
  debug:
    msg: |
      System Information:
      - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      - Kernel: {{ ansible_kernel }}
      - CPU Cores: {{ ansible_processor_vcpus }}
      - Memory: {{ ansible_memtotal_mb }} MB
      - Disk Space: {{ ansible_mounts[0].size_available | human_readable }}